<!-- HTML header for doxygen 1.9.5-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>D-CASCADE V2: /github/workspace/src/d_finder.py</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">D-CASCADE V2
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_2github_2workspace_2src_2d_finder_8py-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">/github/workspace/src/d_finder.py</div></div>
</div><!--header-->
<div class="contents">
<p>Computes the grain size corresponding to a given cumulative percentage (DXX) for a reach with a specified grain size distribution.</p>
<p>Computes the grain size corresponding to a given cumulative percentage (DXX) for a reach with a specified grain size distribution.</p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">fi_r</td><td>Array of fractions of material in each grain size class for one reach (1D) or for all reaches (2D). For example, [0.15, 0.50, 0.35] represents 15%, 50%, and 35% of material in three grain size classes. </td></tr>
    <tr><td class="paramname">d_value</td><td>The target DXX value (e.g., 50 for D50, 90 for D90) representing the grain size for which X% of the material is finer. </td></tr>
    <tr><td class="paramname">psi</td><td>Array of grain sizes in negative log base-2 scale. For example, <code>-3</code> represents 2³ = 8 mm, <code>-4</code> represents 2⁴ = 16 mm.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Array of computed grain sizes (in meters) corresponding to the requested DXX for each input layer. If only one grain size class is present, the function returns that grain size. If <code>d_value</code> equals 100, it returns the smallest grain size.</dd></dl>
<ul>
<li>The function supports both single-layer (<code>fi_r</code> as a vector) and multi-layer (<code>fi_r</code> as a matrix) inputs. For multi-layer cases, it processes each layer independently.</li>
<li>The function assumes that the provided grain sizes in <code>psi</code> are the maximum sizes of each class and not average sizes.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>The grain size distribution is interpolated in logarithmic (base-2) space, as is standard in sedimentology, and converted back to linear scale in meters.</dd></dl>
<div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>fi_r = [0.15, 0.50, 0.35]</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span>d_value = 50</div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span>psi = [-3, -4, -5]</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>result = D_finder(fi_r, d_value, psi)</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="lineno">    1</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">    2</span><span class="stringliteral">Created on Fri Oct 14 16:56:59 2022</span></div>
<div class="line"><span class="lineno">    3</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">    4</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">    5</span><span class="stringliteral">This script was adapted from the Matlab version by Marco Tangi</span></div>
<div class="line"><span class="lineno">    6</span><span class="stringliteral">@author: Elisa Bozzolan</span></div>
<div class="line"><span class="lineno">    7</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">    8</span> </div>
<div class="line"><span class="lineno">    9</span> </div>
<div class="line"><span class="lineno">   10</span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><span class="lineno">   11</span><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div>
<div class="line"><span class="lineno">   12</span> </div>
<div class="line"><span class="lineno">   13</span><span class="comment"># ignore divide by 0</span></div>
<div class="line"><span class="lineno">   14</span>np.seterr(divide=<span class="stringliteral">&#39;ignore&#39;</span>, invalid=<span class="stringliteral">&#39;ignore&#39;</span>)</div>
<div class="line"><span class="lineno">   15</span> </div>
<div class="line"><span class="lineno">   16</span> </div>
<div class="line"><span class="lineno">   17</span> </div>
<div class="line"><span class="lineno">   18</span> </div>
<div class="line"><span class="lineno">   19</span><span class="keyword">def </span>D_finder(fi_r, d_value, psi):</div>
<div class="line"><span class="lineno">   20</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   21</span><span class="stringliteral">    @brief Computes the grain size corresponding to a given cumulative percentage (DXX)</span></div>
<div class="line"><span class="lineno">   22</span><span class="stringliteral">           for a reach with a specified grain size distribution.</span></div>
<div class="line"><span class="lineno">   23</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   24</span><span class="stringliteral">    @param fi_r Array of fractions of material in each grain size class for one reach (1D)</span></div>
<div class="line"><span class="lineno">   25</span><span class="stringliteral">                or for all reaches (2D).</span></div>
<div class="line"><span class="lineno">   26</span><span class="stringliteral">                For example, [0.15, 0.50, 0.35] represents 15%, 50%, and 35% of material</span></div>
<div class="line"><span class="lineno">   27</span><span class="stringliteral">                in three grain size classes.</span></div>
<div class="line"><span class="lineno">   28</span><span class="stringliteral">    @param d_value The target DXX value (e.g., 50 for D50, 90 for D90) representing the</span></div>
<div class="line"><span class="lineno">   29</span><span class="stringliteral">                   grain size for which X% of the material is finer.</span></div>
<div class="line"><span class="lineno">   30</span><span class="stringliteral">    @param psi Array of grain sizes in negative log base-2 scale. For example,</span></div>
<div class="line"><span class="lineno">   31</span><span class="stringliteral">               `-3` represents 2³ = 8 mm, `-4` represents 2⁴ = 16 mm.</span></div>
<div class="line"><span class="lineno">   32</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   33</span><span class="stringliteral">    @return Array of computed grain sizes (in meters) corresponding to the requested DXX</span></div>
<div class="line"><span class="lineno">   34</span><span class="stringliteral">            for each input layer. If only one grain size class is present, the function</span></div>
<div class="line"><span class="lineno">   35</span><span class="stringliteral">            returns that grain size. If `d_value` equals 100, it returns the smallest</span></div>
<div class="line"><span class="lineno">   36</span><span class="stringliteral">            grain size.</span></div>
<div class="line"><span class="lineno">   37</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   38</span><span class="stringliteral">    @details</span></div>
<div class="line"><span class="lineno">   39</span><span class="stringliteral">    - The function supports both single-layer (`fi_r` as a vector) and multi-layer (`fi_r`</span></div>
<div class="line"><span class="lineno">   40</span><span class="stringliteral">      as a matrix) inputs. For multi-layer cases, it processes each layer independently.</span></div>
<div class="line"><span class="lineno">   41</span><span class="stringliteral">    - The function assumes that the provided grain sizes in `psi` are the maximum sizes</span></div>
<div class="line"><span class="lineno">   42</span><span class="stringliteral">      of each class and not average sizes.</span></div>
<div class="line"><span class="lineno">   43</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   44</span><span class="stringliteral">    @note The grain size distribution is interpolated in logarithmic (base-2) space,</span></div>
<div class="line"><span class="lineno">   45</span><span class="stringliteral">          as is standard in sedimentology, and converted back to linear scale in meters.</span></div>
<div class="line"><span class="lineno">   46</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   47</span><span class="stringliteral">    @example</span></div>
<div class="line"><span class="lineno">   48</span><span class="stringliteral">    ```</span></div>
<div class="line"><span class="lineno">   49</span><span class="stringliteral">    fi_r = [0.15, 0.50, 0.35]</span></div>
<div class="line"><span class="lineno">   50</span><span class="stringliteral">    d_value = 50</span></div>
<div class="line"><span class="lineno">   51</span><span class="stringliteral">    psi = [-3, -4, -5]</span></div>
<div class="line"><span class="lineno">   52</span><span class="stringliteral">    result = D_finder(fi_r, d_value, psi)</span></div>
<div class="line"><span class="lineno">   53</span><span class="stringliteral">    ```</span></div>
<div class="line"><span class="lineno">   54</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   55</span> </div>
<div class="line"><span class="lineno">   56</span>    dmi = np.power(2, -psi)/1000</div>
<div class="line"><span class="lineno">   57</span>    nb_classes = len(psi)</div>
<div class="line"><span class="lineno">   58</span> </div>
<div class="line"><span class="lineno">   59</span>    <span class="comment"># Handles the case of single layers input as vector and</span></div>
<div class="line"><span class="lineno">   60</span>    <span class="comment"># multiple layers input as matrices.</span></div>
<div class="line"><span class="lineno">   61</span>    <span class="comment"># (DD: Layer = Number of reaches, sometimes fi_r will be for just one reach, or for all of them)</span></div>
<div class="line"><span class="lineno">   62</span>    <span class="keywordflow">if</span> fi_r.ndim == 1:</div>
<div class="line"><span class="lineno">   63</span>        nb_layers = 1</div>
<div class="line"><span class="lineno">   64</span>        fi_r = np.expand_dims(fi_r, axis=0)</div>
<div class="line"><span class="lineno">   65</span>    <span class="keywordflow">else</span>: <span class="comment"># If multiple layers:</span></div>
<div class="line"><span class="lineno">   66</span>        nb_layers = np.shape(fi_r)[0]</div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   68</span>    <span class="comment"># If one class only, the target DXX value is the grain size of the class.</span></div>
<div class="line"><span class="lineno">   69</span>    <span class="keywordflow">if</span> dmi.size == 1:</div>
<div class="line"><span class="lineno">   70</span>        <span class="keywordflow">return</span> np.full(nb_layers, dmi[0])</div>
<div class="line"><span class="lineno">   71</span> </div>
<div class="line"><span class="lineno">   72</span>    <span class="comment"># The D100 is the grain size of the biggest class.</span></div>
<div class="line"><span class="lineno">   73</span>    <span class="keywordflow">elif</span> d_value == 100:</div>
<div class="line"><span class="lineno">   74</span>        <span class="keywordflow">return</span> np.full(nb_layers, dmi[0])</div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">   77</span>        <span class="comment"># Computes the inverse cumulative percentage of finer material,</span></div>
<div class="line"><span class="lineno">   78</span>        <span class="comment"># class by class, for each layer.</span></div>
<div class="line"><span class="lineno">   79</span>        <span class="comment"># Assumes that the given grain size is the maximum grain size of each</span></div>
<div class="line"><span class="lineno">   80</span>        <span class="comment"># class, and not the average grain size, for example.</span></div>
<div class="line"><span class="lineno">   81</span>        perc_finer = np.empty(np.shape(fi_r))</div>
<div class="line"><span class="lineno">   82</span>        perc_finer[:] = np.nan</div>
<div class="line"><span class="lineno">   83</span>        perc_finer[:,0] = 100</div>
<div class="line"><span class="lineno">   84</span>        <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(1, nb_classes):</div>
<div class="line"><span class="lineno">   85</span>            perc_finer[:,i] = perc_finer[:,i-1] - fi_r[:,i-1] * 100</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>        <span class="comment"># Computes the target DXX value.</span></div>
<div class="line"><span class="lineno">   88</span>        d_changes = np.zeros(nb_layers)</div>
<div class="line"><span class="lineno">   89</span>        <span class="keywordflow">for</span> k <span class="keywordflow">in</span> range(nb_layers):</div>
<div class="line"><span class="lineno">   90</span> </div>
<div class="line"><span class="lineno">   91</span>            <span class="comment"># Finds the class index of the percentage just above the target DXX value.</span></div>
<div class="line"><span class="lineno">   92</span>            class_index = np.where(perc_finer[k, :] &gt; d_value)[0].max()</div>
<div class="line"><span class="lineno">   93</span>            <span class="comment"># Ensure within valid range, which means that the interpolation to determine</span></div>
<div class="line"><span class="lineno">   94</span>            <span class="comment"># the target DXX value, if below the smallest material fraction, will be</span></div>
<div class="line"><span class="lineno">   95</span>            <span class="comment"># based on the adjacent above interval.</span></div>
<div class="line"><span class="lineno">   96</span>            class_index = np.minimum(class_index, nb_classes - 2)</div>
<div class="line"><span class="lineno">   97</span> </div>
<div class="line"><span class="lineno">   98</span>            <span class="comment"># Interpolation</span></div>
<div class="line"><span class="lineno">   99</span>            perc_diff = perc_finer[k, class_index] - perc_finer[k, class_index + 1] <span class="comment"># Is positive</span></div>
<div class="line"><span class="lineno">  100</span>            psi_diff = -psi[class_index] + psi[class_index + 1]  <span class="comment"># Is also positive</span></div>
<div class="line"><span class="lineno">  101</span>            <span class="comment"># How much of the target cumulative percentage (d_value) lies above</span></div>
<div class="line"><span class="lineno">  102</span>            <span class="comment"># the percentage for class_index + 1, divided by the cumulative percentage</span></div>
<div class="line"><span class="lineno">  103</span>            <span class="comment"># difference to get a fraction.</span></div>
<div class="line"><span class="lineno">  104</span>            interpolated_fraction = (d_value - perc_finer[k, class_index + 1]) / perc_diff</div>
<div class="line"><span class="lineno">  105</span>            <span class="comment"># Apply this fractional position to the grain size values and add the</span></div>
<div class="line"><span class="lineno">  106</span>            <span class="comment"># grain size values for class index + 1.</span></div>
<div class="line"><span class="lineno">  107</span>            d_changes[k] = interpolated_fraction * psi_diff - psi[class_index + 1] <span class="comment"># DD: gives minus the D50 in phi scale (see if we can change it to be more clear)</span></div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span>            <span class="comment"># Converts back to meters (DD: D50 in phi scale is already minus, so there is no - in the formula)</span></div>
<div class="line"><span class="lineno">  110</span>            d_changes[k] = np.power(2, d_changes[k]) / 1000</div>
<div class="line"><span class="lineno">  111</span>            <span class="comment"># Ensures no negative sizes by replacing them with the smallest size in dmi</span></div>
<div class="line"><span class="lineno">  112</span>            d_changes[k] = d_changes[k] * (d_changes[k] &gt; 0) + dmi[-1] * (d_changes[k] &lt; 0)</div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>            <span class="comment"># DD: Put a boundary so that we don&#39;t produce D50 out of the user chosen size range</span></div>
<div class="line"><span class="lineno">  115</span>            <span class="comment"># to be thought better maybe ?</span></div>
<div class="line"><span class="lineno">  116</span>            <span class="keywordflow">if</span> d_changes[k] &gt; dmi[0]:</div>
<div class="line"><span class="lineno">  117</span>                d_changes[k] = dmi[0]</div>
<div class="line"><span class="lineno">  118</span> </div>
<div class="line"><span class="lineno">  119</span>            <span class="keywordflow">if</span> d_changes[k] &lt; dmi[-1]:</div>
<div class="line"><span class="lineno">  120</span>                d_changes[k] = dmi[-1]</div>
<div class="line"><span class="lineno">  121</span> </div>
<div class="line"><span class="lineno">  122</span>        <span class="keywordflow">return</span> d_changes</div>
<div class="line"><span class="lineno">  123</span> </div>
<div class="line"><span class="lineno">  124</span> </div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
